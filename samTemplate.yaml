AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Testing CICD Lmabda

Parameters:
  LambdaFullAccessRole:
    Type: String
    Description: Lambda Full access Role
    Default: arn:aws:iam::337769067848:role/LambdaFullAccess
  TargetS3Bucket:
    Type: String
    Description: Target S3 Bucket
    Default: aws-data-common
  DBSecretID:
    Type: String
    Description: DB secret ID
    Default: db-secrets-recursive-lambda

Resources:
  PythonLibrariesLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes:
        - python3.6
      ContentUri: ./codes/aws_lambda_codes/LambdaLib
      Description: Reusable library functions and configuration
      LayerName: python_lambda_libraries
      RetentionPolicy: Retain

  RecursiveLambda:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: recursive_lambda.lambda_handler
      Runtime: python3.8
      CodeUri: ./codes/aws_lambda_codes/recursiveLambda
      Description: 'Recursive lambda for extracting the data'
      MemorySize: 128
      Timeout: 30
      Environment:
        Variables:
          targetS3Bucket: lambdadb
          DBsecret: admin
          TargetLoc: recursicelambdatgt/
      Layers: !Ref PythonLibrariesLayer
      Role: !Ref LambdaFullAccessRole

  CDDemoLambda:
    Type: 'AWS::Serverless::Function'
    Properties:
      Handler: lambda_function.lambda_handler
      Runtime: python3.8
      CodeUri: ./codes/aws_lambda_codes/LambdaCode
      Description: 'Testing Lambda'
      MemorySize: 128
      Timeout: 30
      Role: 'arn:aws:iam::337769067848:role/LambdaFullAccess'

  GlueStack:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: https://aws-data-common.s3.ap-south-1.amazonaws.com/templates/glueTemplate.yaml
      TimeoutInMinutes: 60

  SecretsStack:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: https://aws-data-common.s3.ap-south-1.amazonaws.com/templates/secretsTemplate.yaml
      TimeoutInMinutes: 60
